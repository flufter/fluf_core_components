name: Patch Android

on:
  workflow_call:
    inputs:
      environment:
        required: true
        type: string
        description: "The environment to patch (prod, stag, testing)"
      semantic_version:
        required: true
        type: string
        description: "The semantic version (X.Y.Z)"
      build_number:
        required: true
        type: string
        description: "The build number"
      flutter_version:
        required: true
        type: string
        description: "The Flutter version to use"

jobs:
  patch-android:
    name: Patch Android ({{=<% %>=}}${{ inputs.environment }}<%={{ }}=%>)
    runs-on: ubuntu-latest
    timeout-minutes: 30
    env:
      ENV: {{=<% %>=}}${{ inputs.environment }}<%={{ }}=%>
    steps:
      - uses: actions/checkout@v4

      # --- Java Setup ---
      - name: Set up Java 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      # --- Flutter Setup ---
      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: {{=<% %>=}}${{ inputs.flutter_version }}<%={{ }}=%>
          channel: stable
          cache: true

      - name: Verify Flutter installation
        run: flutter --version

      # --- Environment variable to uppercase ---
      - name: Compute uppercase environment name
        run: |
          ENV_UPPER=$(echo "{{=<% %>=}}${{ inputs.environment }}<%={{ }}=%>" | tr '[:lower:]' '[:upper:]')
          echo "ENV_UPPER=$ENV_UPPER" >> $GITHUB_ENV

      # --- Decode env vars and config files from secrets ---
      - name: Copy environment configuration files
        env:
          ENV_VARS_KEYS_PROD: {{=<% %>=}}${{ secrets.ENV_VARS_KEYS_PROD }}<%={{ }}=%>
          ENV_VARS_KEYS_STAG: {{=<% %>=}}${{ secrets.ENV_VARS_KEYS_STAG }}<%={{ }}=%>
          ENV_VARS_KEYS_TESTING: {{=<% %>=}}${{ secrets.ENV_VARS_KEYS_TESTING }}<%={{ }}=%>
        run: |
          # Create required directories
          mkdir -p ".fluf/config/$ENV"

          # Select the right secret based on environment
          ENV_VARS_SECRET="ENV_VARS_KEYS_${ENV_UPPER}"
          ENV_VARS_VALUE="${!ENV_VARS_SECRET}"

          if [ -z "$ENV_VARS_VALUE" ]; then
            echo "ERROR: $ENV_VARS_SECRET is not set."
            exit 1
          fi

          echo "$ENV_VARS_VALUE" | base64 --decode > ".fluf/config/$ENV/.env"
          echo " - Environment Keys File Copied at .fluf/config/$ENV/.env"

      {{#has_core_firebase}}
      - name: Copy Firebase configuration files
        env:
          FIREBASE_OPTIONS_PROD: {{=<% %>=}}${{ secrets.FIREBASE_OPTIONS_PROD }}<%={{ }}=%>
          FIREBASE_OPTIONS_STAG: {{=<% %>=}}${{ secrets.FIREBASE_OPTIONS_STAG }}<%={{ }}=%>
          FIREBASE_OPTIONS_TESTING: {{=<% %>=}}${{ secrets.FIREBASE_OPTIONS_TESTING }}<%={{ }}=%>
          GOOGLE_SERVICE_ANDROID_PROD: {{=<% %>=}}${{ secrets.GOOGLE_SERVICE_ANDROID_PROD }}<%={{ }}=%>
          GOOGLE_SERVICE_ANDROID_STAG: {{=<% %>=}}${{ secrets.GOOGLE_SERVICE_ANDROID_STAG }}<%={{ }}=%>
          GOOGLE_SERVICE_ANDROID_TESTING: {{=<% %>=}}${{ secrets.GOOGLE_SERVICE_ANDROID_TESTING }}<%={{ }}=%>
        run: |
          # Create required directories
          mkdir -p "lib"
          mkdir -p "android/app/src/$ENV"

          # Firebase Options
          FIREBASE_SECRET="FIREBASE_OPTIONS_${ENV_UPPER}"
          FIREBASE_VALUE="${!FIREBASE_SECRET}"
          if [ -z "$FIREBASE_VALUE" ]; then
            echo "ERROR: $FIREBASE_SECRET is not set."
          else
            echo "$FIREBASE_VALUE" | base64 --decode > "lib/firebase_options_$ENV.dart"
            echo " - Firebase Config File Copied"
          fi

          # Android google-services.json
          ANDROID_SECRET="GOOGLE_SERVICE_ANDROID_${ENV_UPPER}"
          ANDROID_VALUE="${!ANDROID_SECRET}"
          if [ -z "$ANDROID_VALUE" ]; then
            echo "ERROR: $ANDROID_SECRET is not set."
          else
            echo "$ANDROID_VALUE" | base64 --decode > "android/app/src/$ENV/google-services.json"
            echo " - Android Config File Copied"
          fi
      {{/has_core_firebase}}

      # --- Android Signing ---
      - name: Decode Android Keystore
        env:
          ANDROID_KEYSTORE_BASE64: {{=<% %>=}}${{ secrets.ANDROID_KEYSTORE_BASE64 }}<%={{ }}=%>
        run: |
          echo "$ANDROID_KEYSTORE_BASE64" | base64 --decode > android/app/keystore.jks

      - name: Setup Android local properties
        run: |
          echo "flutter.sdk=$FLUTTER_ROOT" > android/local.properties

      # --- Build ---
      - name: Clean and rebuild Flutter app
        run: |
          flutter clean
          flutter pub get
          if grep -q "build_runner" pubspec.yaml; then
            echo "Running build_runner..."
            flutter pub run build_runner build --delete-conflicting-outputs
          else
            echo "build_runner not found in pubspec.yaml. Skipping build_runner."
          fi

      {{#has_core_firebase}}
      - name: Install FlutterFire CLI
        run: dart pub global activate flutterfire_cli
      {{/has_core_firebase}}

      - name: Build Font Awesome Icons
        run: |
          DIR="cloned/font_awesome_flutter/"
          if [ -d "$DIR" ]; then
            echo "Directory $DIR exists."
            cd "$DIR"
            flutter pub get
            cd -
          else
            echo "Directory $DIR does not exist. Skipping."
          fi

      # --- Shorebird Patch ---
      - name: Install Shorebird CLI
        run: |
          curl --proto '=https' --tlsv1.2 https://raw.githubusercontent.com/shorebirdtech/install/main/install.sh -sSf | bash
          echo "$HOME/.shorebird/bin" >> $GITHUB_PATH

      - name: Patch Android (Shorebird)
        env:
          SHOREBIRD_TOKEN: {{=<% %>=}}${{ secrets.SHOREBIRD_TOKEN }}<%={{ }}=%>
          KEYSTORE_PATH: keystore.jks
          KEYSTORE_PASSWORD: {{=<% %>=}}${{ secrets.ANDROID_KEYSTORE_PASSWORD }}<%={{ }}=%>
          KEY_ALIAS: {{=<% %>=}}${{ secrets.ANDROID_KEY_ALIAS }}<%={{ }}=%>
          KEY_PASSWORD: {{=<% %>=}}${{ secrets.ANDROID_KEY_PASSWORD }}<%={{ }}=%>
        run: |
          PATCH_RELEASE_VERSION="{{=<% %>=}}${{ inputs.semantic_version }}<%={{ }}=%>+{{=<% %>=}}${{ inputs.build_number }}<%={{ }}=%>"
          echo "Building Patch for version: $PATCH_RELEASE_VERSION"

          shorebird patch android --flavor $ENV \
            -t lib/main_${ENV}.dart \
            --flavor $ENV \
            --release-version "$PATCH_RELEASE_VERSION"

      # --- Notify ---
      - name: Send email notification
        if: always()
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: {{=<% %>=}}${{ secrets.SMTP_SERVER }}<%={{ }}=%>
          server_port: {{=<% %>=}}${{ secrets.SMTP_PORT }}<%={{ }}=%>
          username: {{=<% %>=}}${{ secrets.SMTP_USERNAME }}<%={{ }}=%>
          password: {{=<% %>=}}${{ secrets.SMTP_PASSWORD }}<%={{ }}=%>
          subject: "Android Patch ({{=<% %>=}}${{ inputs.environment }}<%={{ }}=%>) - {{=<% %>=}}${{ job.status }}<%={{ }}=%>"
          to: {{email_address}}
          from: "GitHub Actions <noreply@github.com>"
          body: |
            Android patch for {{=<% %>=}}${{ inputs.environment }}<%={{ }}=%> environment completed with status: {{=<% %>=}}${{ job.status }}<%={{ }}=%>
            Version: {{=<% %>=}}${{ inputs.semantic_version }}<%={{ }}=%>+{{=<% %>=}}${{ inputs.build_number }}<%={{ }}=%>
            Repository: {{=<% %>=}}${{ github.repository }}<%={{ }}=%>
            Branch: {{=<% %>=}}${{ github.ref }}<%={{ }}=%>
        continue-on-error: true
